<!doctype html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Sales Agent Chat</title>

	<!-- Google Font -->
	<link rel="preconnect" href="https://fonts.googleapis.com" />
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />

	<!-- Tailwind CDN -->
	<script src="https://cdn.tailwindcss.com"></script>
	<script>
		tailwind.config = {
			theme: {
				extend: {
					fontFamily: { sans: ["Inter", "system-ui", "sans-serif"] },
				},
			},
		};
	</script>

	<style>
		/* Meta-ish: clean, airy, subtle glass */
		:root {
			color-scheme: light;
		}

		.glass {
			background: rgba(255, 255, 255, 0.72);
			backdrop-filter: blur(16px);
			-webkit-backdrop-filter: blur(16px);
			border: 1px solid rgba(0, 0, 0, 0.06);
		}

		.soft-shadow {
			box-shadow:
				0 10px 30px rgba(0, 0, 0, 0.08),
				0 1px 0 rgba(0, 0, 0, 0.06);
		}

		.focus-ring:focus {
			outline: none;
			box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
			border-color: rgba(59, 130, 246, 0.55);
		}

		/* nice scroll without extra libs */
		#messages::-webkit-scrollbar {
			width: 10px;
		}

		#messages::-webkit-scrollbar-thumb {
			background: rgba(0, 0, 0, 0.12);
			border-radius: 999px;
			border: 3px solid rgba(255, 255, 255, 0.8);
		}
	</style>
</head>

<body class="min-h-screen font-sans bg-gradient-to-b from-slate-50 to-white text-slate-900">
	<div class="mx-auto max-w-3xl px-4 py-8">
		<header class="mb-5">
			<div class="flex items-center justify-between">
				<div>
					<h1 class="text-xl font-semibold tracking-tight">Sales Agent</h1>
					<p class="text-sm text-slate-600">POST to <span class="font-mono">/api/v1/sales-agent/chat</span></p>
				</div>
				<button id="clearBtn"
					class="text-sm px-3 py-2 rounded-xl border border-black/10 bg-white hover:bg-slate-50 active:scale-[0.99] transition"
					type="button">
					Clear
				</button>
			</div>
		</header>

		<main class="glass soft-shadow rounded-3xl overflow-hidden">
			<div class="px-4 py-3 border-b border-black/5 bg-white/60">
				<div class="flex items-center gap-2 text-sm text-slate-600">
					<span class="inline-flex h-2.5 w-2.5 rounded-full bg-emerald-500"></span>
					<span id="statusText">Ready</span>
				</div>
			</div>

			<div id="messages" class="h-[62vh] overflow-y-auto p-4 space-y-3 bg-white/40"></div>

			<div class="p-3 border-t border-black/5 bg-white/60">
				<form id="chatForm" class="flex gap-2 items-start">
					<div class="flex-1">
						<label class="sr-only" for="messageInput">Message</label>
						<textarea id="messageInput" rows="1" placeholder="Type a message…"
							class="w-full resize-none rounded-2xl border border-black/10 bg-white px-4 py-3 text-[15px] focus-ring"></textarea>
					</div>

					<button id="sendBtn" type="submit"
						class="rounded-2xl px-4 py-3 text-[15px] font-medium text-white bg-slate-900 hover:bg-slate-800 active:scale-[0.94] transition disabled:opacity-50 disabled:cursor-not-allowed">
						Send
					</button>
				</form>
			</div>
		</main>
	</div>

	<script>
		const API_URL = "http://localhost:3000/api/v1/sales-agent/chat";

		const messagesEl = document.getElementById("messages");
		const formEl = document.getElementById("chatForm");
		const inputEl = document.getElementById("messageInput");
		const sendBtn = document.getElementById("sendBtn");
		const clearBtn = document.getElementById("clearBtn");
		const statusText = document.getElementById("statusText");

		// auto-grow textarea
		function autoGrow() {
			inputEl.style.height = "auto";
			inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + "px";
		}
		inputEl.addEventListener("input", autoGrow);
		autoGrow();

		function scrollToBottom() {
			messagesEl.scrollTop = messagesEl.scrollHeight;
		}

		function bubble({ role, text }) {
			const wrap = document.createElement("div");
			wrap.className = "flex";

			const isUser = role === "user";
			wrap.classList.add(isUser ? "justify-end" : "justify-start");

			const b = document.createElement("div");
			b.className =
				"max-w-[85%] rounded-3xl px-4 py-3 text-[15px] leading-6 border " +
				(isUser
					? "bg-slate-900 text-white border-slate-900"
					: "bg-white text-slate-900 border-black/10");

			// keep it simple: safe text only
			b.innerHTML = text;

			wrap.appendChild(b);
			messagesEl.appendChild(wrap);
			scrollToBottom();
		}

		function setStatus(text, busy = false) {
			statusText.textContent = text;
			sendBtn.disabled = busy;
			inputEl.disabled = busy;
		}

		async function sendMessage(message) {
			setStatus("Sending…", true);

			try {
				const res = await fetch(API_URL, {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ message }),
				});

				const contentType = res.headers.get("content-type") || "";
				let data;

				if (contentType.includes("application/json")) {
					data = await res.json();
				} else {
					data = await res.text();
				}

				if (!res.ok) {
					const msg = typeof data === "string" ? data : (data?.error || JSON.stringify(data));
					throw new Error(msg || "Request failed");
				}

				// Flexible: accept common response shapes
				// - { message: "..." }
				// - { reply: "..." }
				// - { data: "..." }
				// - plain text
				const reply =
					typeof data === "string"
						? data
						: (data?.message ?? data?.reply ?? data?.data ?? JSON.stringify(data));

				bubble({ role: "agent", text: reply });
				setStatus("Ready");
			} catch (err) {
				bubble({ role: "agent", text: `Error: ${err.message}` });
				setStatus("Ready");
				hintEl.textContent = "Check your server/CORS and endpoint response format.";
			} finally {
				setStatus("Ready", false);
				inputEl.focus();
			}
		}

		formEl.addEventListener("submit", (e) => {
			e.preventDefault();
			const message = inputEl.value.trim();
			if (!message) return;

			bubble({ role: "user", text: message });
			inputEl.value = "";
			autoGrow();
			sendMessage(message);
		});

		// Enter to send, Shift+Enter for newline
		inputEl.addEventListener("keydown", (e) => {
			if (e.key === "Enter" && !e.shiftKey) {
				e.preventDefault();
				formEl.requestSubmit();
			}
		});

		clearBtn.addEventListener("click", () => {
			messagesEl.innerHTML = "";
			setStatus("Ready");
			inputEl.focus();
		});
	</script>
</body>

</html>